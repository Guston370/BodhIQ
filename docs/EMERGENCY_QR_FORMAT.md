# Emergency QR Code Format Specification

## Overview
The BodhIQ Medical Agent generates Emergency QR codes that contain critical medical information in a universally readable format. The QR codes are designed to be scannable by any generic QR scanner while maintaining structured data for medical systems.

## Format Structure

### Two-Part Format
The QR payload consists of two parts:
1. **Human-Readable Summary** - Plain text that displays immediately when scanned
2. **Structured JSON Data** - Machine-readable data for medical systems

### Format Example
```
üö® EMERGENCY MEDICAL INFORMATION üö®

Name: John Doe
Blood Group: O+
‚ö†Ô∏è Allergies: Penicillin, Shellfish
Emergency Contact: +1-555-0123
DOB: 1985-03-15
Phone: +1-555-0456

Generated by BodhIQ Medical Agent

---STRUCTURED-DATA---
{
  "schema": "medical-agent.v1",
  "type": "emergency-medical-info",
  "version": 1,
  "patient": {
    "fullName": "John Doe",
    "userId": "user123",
    "dateOfBirth": "1985-03-15",
    "gender": "Male",
    "age": "38"
  },
  "medical": {
    "bloodGroup": "O+",
    "allergies": ["Penicillin", "Shellfish"]
  },
  "contacts": {
    "primaryPhone": "+1-555-0456",
    "email": "john.doe@example.com",
    "emergency": [
      {
        "name": "Emergency Contact",
        "relationship": "Primary",
        "phone": "+1-555-0123"
      }
    ]
  },
  "metadata": {
    "generatedAt": "2025-11-11T10:30:00Z",
    "source": "BodhIQ Medical Agent",
    "dataVersion": 1
  }
}
```

## Schema Version: medical-agent.v1

### Required Fields
- `schema` (string): Schema identifier - "medical-agent.v1"
- `type` (string): Data type - "emergency-medical-info"
- `version` (integer): Format version number
- `patient.fullName` (string): Patient's full name

### Optional Fields

#### Patient Information
- `patient.userId` (string): Unique user identifier
- `patient.dateOfBirth` (string): Date of birth (YYYY-MM-DD)
- `patient.gender` (string): Gender
- `patient.age` (string): Current age

#### Medical Information
- `medical.bloodGroup` (string): Blood type (e.g., "O+", "AB-")
- `medical.allergies` (array): List of known allergies
- `medical.conditions` (array): List of medical conditions

#### Contact Information
- `contacts.primaryPhone` (string): Primary phone number
- `contacts.email` (string): Email address
- `contacts.emergency` (array): Emergency contacts with name, relationship, and phone

#### Metadata
- `metadata.generatedAt` (string): ISO 8601 timestamp
- `metadata.source` (string): Generating application
- `metadata.dataVersion` (integer): Data schema version

## Size Optimization

### Full Format
- Maximum size: 3 KB
- Includes all available information
- Pretty-printed JSON for readability

### Compact Format
Used automatically when full format exceeds size limit:
```
üö® EMERGENCY INFO üö®
John Doe | O+ | ‚ö†Ô∏è Penicillin, Shellfish | üìû +1-555-0123

{"schema":"medical-agent.v1","name":"John Doe","blood":"O+","allergies":["Penicillin","Shellfish"],"contact":"+1-555-0123"}
```

## Backward Compatibility

### Version Handling
- Schema version is included in every payload
- Future versions will maintain backward compatibility
- Parsers should gracefully handle unknown fields
- Required fields will never be removed

### Migration Path
When introducing v2:
- v1 payloads remain valid
- New fields are optional
- Parsers check schema version and adapt

## Scanner Compatibility

### Generic QR Scanners
- Display human-readable summary immediately
- No special parsing required
- Critical information visible at a glance

### Medical System Integration
- Parse JSON after separator
- Validate schema version
- Extract structured data
- Handle missing optional fields gracefully

## Security & Privacy

### Data Included
- Only essential emergency information
- No sensitive medical history
- No authentication credentials
- No financial information

### User Consent
- Explicit consent required before generation
- Clear disclosure of included information
- User controls what data to include

### Recommendations
- Share only with trusted individuals
- Use in emergency situations
- Store securely (e.g., phone lock screen)
- Regenerate periodically

## Testing

### Validation
Use `EmergencyQrValidator` class to validate payloads:
```java
ValidationResult result = EmergencyQrValidator.validate(payload);
if (result.isValid) {
    String summary = result.humanReadable;
    String json = result.structuredData;
}
```

### Test Scanners
Recommended QR scanner apps for testing:
- Google Lens (Android/iOS)
- Built-in camera apps (iOS 11+, Android 9+)
- QR Code Reader by Scan
- ZXing Barcode Scanner

### Verification Checklist
- [ ] Human-readable summary displays correctly
- [ ] All critical information visible
- [ ] JSON parses without errors
- [ ] Schema version matches
- [ ] Required fields present
- [ ] Size under 3 KB limit
- [ ] QR code scans reliably

## Implementation Notes

### Generating QR Codes
```java
// Build payload
String payload = EmergencyPayloadBuilder.build(userProfile);

// Validate size
if (EmergencyPayloadBuilder.exceedsSizeLimit(payload)) {
    payload = EmergencyPayloadBuilder.buildCompact(userProfile);
}

// Generate QR
Bitmap qr = QrUtil.generate(payload, 1000, true, context);
```

### Parsing QR Data
```java
// Extract parts
String summary = EmergencyQrValidator.extractSummary(scannedData);
String json = EmergencyQrValidator.extractJson(scannedData);

// Parse JSON
JsonObject data = JsonParser.parseString(json).getAsJsonObject();
String name = data.getAsJsonObject("patient").get("fullName").getAsString();
```

## Future Enhancements

### Planned Features
- Short URL mode for very large payloads
- Encrypted sensitive data sections
- Digital signatures for verification
- Multi-language support
- Photo/document attachments via URL

### Version 2 Considerations
- Additional medical fields (medications, procedures)
- Healthcare provider information
- Insurance details (optional)
- Advanced directives
- Organ donor status

## Support

For questions or issues:
- Check validation errors using `EmergencyQrValidator`
- Verify scanner compatibility
- Review size limits
- Contact: support@bodhiq.app

---

**Last Updated**: November 11, 2025  
**Schema Version**: medical-agent.v1  
**Document Version**: 1.0
